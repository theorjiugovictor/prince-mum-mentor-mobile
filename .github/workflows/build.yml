name: Build Android Release

on:
  push:
    branches:
      - main
      - staging
      - dev
  pull_request:
    branches:
      - main
      - staging
      - dev
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    # Only run this job for:
    # - push to main or staging
    # - workflow_dispatch (manual run)
    # - pull_request where the base branch is main or staging
    if: >-
      (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'staging')) ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'staging'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Create google-services.json from secret
        run: |
          # write secret contents to android app folder
          mkdir -p android/app

          # Prefer a base64-encoded secret if provided (more robust for multiline)
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" ]; then
            echo "Decoding google-services.json from GOOGLE_SERVICES_JSON_BASE64"
            echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 --decode > android/app/google-services.json || (echo "base64 decode failed" && exit 1)
            echo "Wrote android/app/google-services.json (from base64 secret)"
          else
            # Fallback: try raw JSON secret, else try base64 text stored in the same secret
            SECRET="${{ secrets.GOOGLE_SERVICES_JSON }}"
            printf "%s" "$SECRET" > android/app/google-services.json
            echo "Wrote android/app/google-services.json (attempt as raw JSON)"

            # test JSON validity; if it fails, try base64 decode then re-test
            if jq -e '.' android/app/google-services.json >/dev/null 2>&1; then
              echo "google-services.json is valid JSON"
            else
              echo "Initial JSON parse failed â€” attempting base64 decode of secret"
              echo "$SECRET" | base64 --decode > android/app/google-services.json || (echo "base64 decode failed" && exit 1)
              echo "Wrote android/app/google-services.json (after base64 decode)"
              jq -e '.' android/app/google-services.json >/dev/null 2>&1 || (echo "Decoded content is not valid JSON" && exit 1)
            fi
          fi

          # final check: ensure project_info exists
          jq -e '.project_info' android/app/google-services.json >/dev/null || (echo "google-services.json missing project_info" && exit 1)

      - name: Create .env file with keystore credentials
        run: |
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> .env
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> .env
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> .env
          echo ".env file created successfully"

      - name: Decode and save keystore file
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > keystore.jks
          ls -lah keystore.jks
          echo "Keystore file decoded and saved successfully"

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Run Expo prebuild
        run: npx expo prebuild --clean --platform android

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build Android Release APK with Gradle Cache
        uses: burrunan/gradle-cache-action@v3
        with:
          job-id: build-android-release
          gradle-version: wrapper
          execution-only-caches: true
          arguments: assembleRelease
          build-root-directory: android
          gradle-distribution-sha-256-sum-warning: false

      - name: Verify APK exists
        run: |
          ls -lah android/app/build/outputs/apk/release/
          echo "APK built successfully"

      - name: Get version info
        id: version
        run: |
          VERSION=$(cat package.json | jq -r '.version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          cd android/app/build/outputs/apk/release
          mv app-release.apk MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}.apk
          echo "APK renamed to MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}.apk"

      - name: Upload APK to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.timestamp }}
          path: android/app/build/outputs/apk/release/MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload APK to Appetize.io
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
        run: |
          # ensure jq is available (required to parse response)
          if ! command -v jq >/dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          APK_PATH="android/app/build/outputs/apk/release/MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "APK not found at $APK_PATH"
            exit 1
          fi

          RESPONSE=$(curl -s -X POST "https://$APPETIZE_API_TOKEN@api.appetize.io/v1/apps" \
            -F "file=@${APK_PATH}" \
            -F "platform=android" \
            -F "note=Build from ${{ github.ref_name }} - v${{ steps.version.outputs.version }} (${{ steps.version.outputs.short_sha }})")

          echo "Appetize Response: $RESPONSE"
          PUBLIC_KEY=$(echo "$RESPONSE" | jq -r '.publicKey // empty')
          if [ -z "$PUBLIC_KEY" ]; then
            echo "Appetize upload failed. Response: $RESPONSE"
            exit 1
          fi

          APP_URL="https://appetize.io/app/$PUBLIC_KEY"

          echo "### ðŸ“± Appetize.io Preview" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** $APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Public Key:** $PUBLIC_KEY" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.version.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY

          echo "appetize_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "appetize_public_key=$PUBLIC_KEY" >> $GITHUB_OUTPUT
#
    

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | v${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ steps.version.outputs.short_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Time** | ${{ steps.version.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **APK Name** | MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}.apk |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Upload Locations" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ GitHub Artifacts" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            echo "- ðŸ“± Appetize.io" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### ðŸ¤– Android Build Complete
            
            | Property | Value |
            |----------|-------|
            | **Version** | v${{ steps.version.outputs.version }} |
            | **Commit** | ${{ steps.version.outputs.short_sha }} |
            | **APK** | MumMentor-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}.apk |
            
            ðŸ“¦ **Download:** Available in [GitHub Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            *Build completed at ${{ steps.version.outputs.timestamp }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f .env
          rm -f keystore.jks
          rm -f android/app/google-services.json
          echo "Sensitive files cleaned up"

  build-ios:
    name: Build iOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Decode GoogleService-Info.plist
        run: |
          mkdir -p ios/Runner
          echo $GOOGLE_SERVICE_INFO_PLIST_BASE64 | base64 --decode > ios/Runner/GoogleService-Info.plist

      - name: Verify Podfile exists
        run: |
          if [ ! -f ios/Podfile ]; then
            echo "Podfile not found in ios directory. Exiting."
            exit 1
          fi

      - name: Install CocoaPods
        run: pod install --project-directory=ios

      - name: Build iOS App
        run: |
          xcodebuild \
            -workspace ios/MumMentor.xcworkspace \
            -scheme MumMentor \
            -sdk iphoneos \
            -configuration Release \
            -archivePath ios/build/MumMentor.xcarchive \
            archive

      - name: Export .ipa File
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath ios/build/MumMentor.xcarchive \
            -exportPath ios/build \
            -exportOptionsPlist ios/ExportOptions.plist
